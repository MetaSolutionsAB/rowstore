image: metasolutions/openjdk-node-postgresql

options:
  max-time: 10

pipelines:
  default:
    - step:
        caches:
          - maven
        script:
          - mvn --version
          - mvn clean install
          - /etc/init.d/postgresql start
          - sudo -u postgres sh -c 'createuser rowstoretest & createdb rowstoretest'
          - sudo -u postgres psql -c "ALTER USER rowstoretest PASSWORD 'rowstoretestpw';"
          - chmod +x standalone/target/dist/bin/rowstore
          - standalone/target/dist/bin/rowstore tests/rowstore_tests.json 8282 &
          - sleep 5
          - pushd tests
          - npm install -g jasmine-node
          - npm install frisby@0.8.5
          - jasmine-node .
          - popd
          - ( cd standalone/target/dist && tar czf rowstore-`cat ../../../VERSION.txt`.tar.gz * )
          - scp -v webapp/target/*.war standalone/target/dist/*.tar.gz deploy@meta1.metasolutions.se:/var/www/entrystore.org/download/
          - rm -rf ~/.m2/repository/org/entrystore/
